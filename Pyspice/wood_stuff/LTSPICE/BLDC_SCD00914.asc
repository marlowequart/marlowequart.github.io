Version 4
SHEET 1 4892 3108
WIRE 2272 592 1808 592
WIRE 2336 592 2272 592
WIRE 2272 608 2272 592
WIRE 720 624 448 624
WIRE 768 624 720 624
WIRE 2640 624 2544 624
WIRE 2736 624 2640 624
WIRE 2880 624 2736 624
WIRE 208 640 128 640
WIRE 448 640 448 624
WIRE 720 640 720 624
WIRE 2640 640 2640 624
WIRE 2736 640 2736 624
WIRE 1296 656 1168 656
WIRE 2544 656 2544 624
WIRE 992 672 960 672
WIRE 208 688 160 688
WIRE 992 688 992 672
WIRE 1168 688 1168 656
WIRE 176 736 144 736
WIRE 2544 736 2544 720
WIRE 2640 736 2640 720
WIRE 2640 736 2544 736
WIRE 2736 736 2736 720
WIRE 2736 736 2640 736
WIRE 2736 752 2736 736
WIRE 2640 816 2544 816
WIRE 2736 816 2640 816
WIRE 2880 816 2736 816
WIRE 1072 832 992 832
WIRE 1168 832 1072 832
WIRE 1328 832 1168 832
WIRE 1712 832 1616 832
WIRE 1808 832 1808 592
WIRE 1808 832 1712 832
WIRE 2096 832 2000 832
WIRE 2192 832 2096 832
WIRE 2336 832 2192 832
WIRE 2640 832 2640 816
WIRE 2736 832 2736 816
WIRE 1072 848 1072 832
WIRE 1168 848 1168 832
WIRE 1616 848 1616 832
WIRE 1808 848 1808 832
WIRE 2000 848 2000 832
WIRE 2192 848 2192 832
WIRE 2544 848 2544 816
WIRE 992 864 992 832
WIRE 1712 864 1712 832
WIRE 2096 864 2096 832
WIRE 2544 928 2544 912
WIRE 2640 928 2640 912
WIRE 2640 928 2544 928
WIRE 2736 928 2736 912
WIRE 2736 928 2640 928
WIRE 992 944 992 928
WIRE 1072 944 1072 928
WIRE 1072 944 992 944
WIRE 1168 944 1168 928
WIRE 1168 944 1072 944
WIRE 1616 944 1616 928
WIRE 1712 944 1712 928
WIRE 1712 944 1616 944
WIRE 1808 944 1808 928
WIRE 1808 944 1712 944
WIRE 2000 944 2000 928
WIRE 2096 944 2096 928
WIRE 2096 944 2000 944
WIRE 2192 944 2192 928
WIRE 2192 944 2096 944
WIRE 2736 944 2736 928
WIRE 1168 960 1168 944
WIRE 1808 960 1808 944
WIRE 2192 960 2192 944
WIRE 2640 1008 2544 1008
WIRE 2736 1008 2640 1008
WIRE 2880 1008 2736 1008
WIRE 2640 1024 2640 1008
WIRE 2736 1024 2736 1008
WIRE 2544 1040 2544 1008
WIRE 2544 1120 2544 1104
WIRE 2640 1120 2640 1104
WIRE 2640 1120 2544 1120
WIRE 2736 1120 2736 1104
WIRE 2736 1120 2640 1120
WIRE 2736 1136 2736 1120
WIRE 416 1536 368 1536
WIRE 1120 1536 1088 1536
WIRE 368 1568 368 1536
WIRE 1088 1568 1088 1536
WIRE 2128 1744 592 1744
WIRE 2544 1744 2128 1744
WIRE 2816 1744 2688 1744
WIRE 2128 1760 2128 1744
WIRE 2544 1760 2544 1744
WIRE 752 1776 720 1776
WIRE 1120 1776 1072 1776
WIRE 1648 1776 1552 1776
WIRE 1744 1776 1648 1776
WIRE 1824 1776 1744 1776
WIRE 2496 1776 2480 1776
WIRE 2688 1776 2688 1744
WIRE 1552 1792 1552 1776
WIRE 1744 1792 1744 1776
WIRE 720 1808 720 1776
WIRE 1072 1808 1072 1776
WIRE 1648 1808 1648 1776
WIRE 592 1840 592 1744
WIRE 592 1840 128 1840
WIRE 2496 1840 2496 1824
WIRE 1552 1888 1552 1872
WIRE 1648 1888 1648 1872
WIRE 1648 1888 1552 1888
WIRE 1744 1888 1744 1872
WIRE 1744 1888 1648 1888
WIRE 2128 1888 2128 1840
WIRE 2128 1888 2064 1888
WIRE 2272 1888 2128 1888
WIRE 2544 1888 2544 1840
WIRE 2544 1888 2352 1888
WIRE 1744 1904 1744 1888
WIRE 416 1952 368 1952
WIRE 1120 1952 1088 1952
WIRE 368 1984 368 1952
WIRE 1088 1984 1088 1952
WIRE 2128 2160 592 2160
WIRE 2544 2160 2128 2160
WIRE 2816 2160 2688 2160
WIRE 2128 2176 2128 2160
WIRE 2544 2176 2544 2160
WIRE 752 2192 720 2192
WIRE 1120 2192 1072 2192
WIRE 1648 2192 1552 2192
WIRE 1744 2192 1648 2192
WIRE 1824 2192 1744 2192
WIRE 2496 2192 2480 2192
WIRE 2688 2192 2688 2160
WIRE 1552 2208 1552 2192
WIRE 1744 2208 1744 2192
WIRE 720 2224 720 2192
WIRE 1072 2224 1072 2192
WIRE 1648 2224 1648 2192
WIRE 592 2256 592 2160
WIRE 592 2256 128 2256
WIRE 2496 2256 2496 2240
WIRE 1552 2304 1552 2288
WIRE 1648 2304 1648 2288
WIRE 1648 2304 1552 2304
WIRE 1744 2304 1744 2288
WIRE 1744 2304 1648 2304
WIRE 2128 2304 2128 2256
WIRE 2128 2304 2064 2304
WIRE 2272 2304 2128 2304
WIRE 2544 2304 2544 2256
WIRE 2544 2304 2352 2304
WIRE 1744 2320 1744 2304
WIRE 416 2368 368 2368
WIRE 1120 2368 1088 2368
WIRE 368 2400 368 2368
WIRE 1088 2400 1088 2368
WIRE 2128 2576 592 2576
WIRE 2544 2576 2128 2576
WIRE 2816 2576 2688 2576
WIRE 2128 2592 2128 2576
WIRE 2544 2592 2544 2576
WIRE 752 2608 720 2608
WIRE 1120 2608 1072 2608
WIRE 1648 2608 1552 2608
WIRE 1744 2608 1648 2608
WIRE 1824 2608 1744 2608
WIRE 2496 2608 2480 2608
WIRE 2688 2608 2688 2576
WIRE 1552 2624 1552 2608
WIRE 1744 2624 1744 2608
WIRE 720 2640 720 2608
WIRE 1072 2640 1072 2608
WIRE 1648 2640 1648 2608
WIRE 592 2672 592 2576
WIRE 592 2672 128 2672
WIRE 2496 2672 2496 2656
WIRE 1552 2720 1552 2704
WIRE 1648 2720 1648 2704
WIRE 1648 2720 1552 2720
WIRE 1744 2720 1744 2704
WIRE 1744 2720 1648 2720
WIRE 2128 2720 2128 2672
WIRE 2128 2720 2064 2720
WIRE 2272 2720 2128 2720
WIRE 2544 2720 2544 2672
WIRE 2544 2720 2352 2720
WIRE 1744 2736 1744 2720
FLAG 128 640 t_in
IOPIN 128 640 In
FLAG 2336 592 w
IOPIN 2336 592 Out
FLAG 160 688 damp
IOPIN 160 688 In
FLAG 2336 832 angle
IOPIN 2336 832 Out
FLAG 1168 960 0
FLAG 1328 832 accel
FLAG 144 736 jload
IOPIN 144 736 In
FLAG 2880 624 h1
IOPIN 2880 624 Out
FLAG 2736 752 0
FLAG 2880 816 h2
IOPIN 2880 816 Out
FLAG 2736 944 0
FLAG 2880 1008 h3
IOPIN 2880 1008 Out
FLAG 2736 1136 0
FLAG 128 1840 phase_a
IOPIN 128 1840 In
FLAG 2064 1888 common
FLAG 992 768 0
FLAG 2816 1744 t_a
FLAG 1744 1904 0
FLAG 1824 1776 i_phs_a
FLAG 32 1776 0
FLAG 32 1696 e_angle_a
FLAG 2192 1200 0
FLAG 2192 1120 npp_angle
FLAG 144 1728 0
FLAG 144 1648 ke_sin_a
FLAG 256 1696 0
FLAG 256 1616 ke_trap_a
FLAG 1072 1888 0
FLAG 1120 1776 e_angle_mod_a
FLAG 720 1888 0
FLAG 752 1776 e_rot_a
FLAG 368 1648 0
FLAG 416 1536 ke_shaped_a
FLAG 1088 1648 0
FLAG 1120 1536 didt_a
FLAG 2496 1840 0
FLAG 2480 1776 i_phs_a
FLAG 2688 1856 0
FLAG 1296 656 t_out
IOPIN 1296 656 Out
FLAG 1168 768 0
FLAG 448 720 0
FLAG 768 624 tx
FLAG 2272 688 0
FLAG 720 720 0
FLAG 448 864 0
FLAG 448 784 tf0
FLAG 448 1008 0
FLAG 448 928 tf1
FLAG 448 1152 0
FLAG 448 1072 tf2
FLAG 448 1296 0
FLAG 448 1216 tf
FLAG 448 1440 0
FLAG 448 1360 ttot
FLAG 208 688 damp
FLAG 176 736 jload
FLAG 1808 960 0
FLAG 2192 960 0
FLAG 208 640 t_in
FLAG 960 672 common
FLAG 128 2256 phase_b
IOPIN 128 2256 In
FLAG 2064 2304 common
FLAG 2816 2160 t_b
FLAG 1744 2320 0
FLAG 1824 2192 i_phs_b
FLAG 32 2192 0
FLAG 32 2112 e_angle_b
FLAG 144 2144 0
FLAG 144 2064 ke_sin_b
FLAG 256 2112 0
FLAG 256 2032 ke_trap_b
FLAG 1072 2304 0
FLAG 1120 2192 e_angle_mod_b
FLAG 720 2304 0
FLAG 752 2192 e_rot_b
FLAG 368 2064 0
FLAG 416 1952 ke_shaped_b
FLAG 1088 2064 0
FLAG 1120 1952 didt_b
FLAG 2496 2256 0
FLAG 2480 2192 i_phs_b
FLAG 2688 2272 0
FLAG 128 2672 phase_c
IOPIN 128 2672 In
FLAG 2064 2720 common
FLAG 2816 2576 t_c
FLAG 1744 2736 0
FLAG 1824 2608 i_phs_c
FLAG 32 2608 0
FLAG 32 2528 e_angle_c
FLAG 144 2560 0
FLAG 144 2480 ke_sin_c
FLAG 256 2528 0
FLAG 256 2448 ke_trap_c
FLAG 1072 2720 0
FLAG 1120 2608 e_angle_mod_c
FLAG 720 2720 0
FLAG 752 2608 e_rot_c
FLAG 368 2480 0
FLAG 416 2368 ke_shaped_c
FLAG 1088 2480 0
FLAG 1120 2368 didt_c
FLAG 2496 2672 0
FLAG 2480 2608 i_phs_c
FLAG 2688 2688 0
SYMBOL bi2 1168 848 R0
SYMATTR InstName B1
SYMATTR Value I=V(ttot)/({Jm}+abs(V(jload)))
SYMBOL res 1056 832 R0
SYMATTR InstName R1
SYMATTR Value 1
SYMBOL cap 976 864 R0
SYMATTR InstName C1
SYMATTR Value 1n
SYMBOL bi2 2736 640 R0
SYMATTR InstName B2
SYMATTR Value I={VDD_Hall}*(0.5*tanh({gHall}*sin({Npp}*(V(Angle)+0+{Ph})+((V(H1)/{VDD_Hall}-0.5)*{Hall_Hyst}/2/pi)))+0.5)
SYMBOL res 2624 624 R0
SYMATTR InstName R2
SYMATTR Value 1
SYMBOL bi2 2736 832 R0
SYMATTR InstName B3
SYMATTR Value I={VDD_Hall}*(0.5*tanh({gHall}*sin({Npp}*(V(Angle)+2*pi/3+{Ph})+((V(H1)/{VDD_Hall}-0.5)*{Hall_Hyst}/2/pi)))+0.5)
SYMBOL res 2624 816 R0
SYMATTR InstName R3
SYMATTR Value 1
SYMBOL bi2 2736 1024 R0
SYMATTR InstName B4
SYMATTR Value I={VDD_Hall}*(0.5*tanh({gHall}*sin({Npp}*(V(Angle)+4*pi/3+{Ph})+((V(H1)/{VDD_Hall}-0.5)*{Hall_Hyst}/2/pi)))+0.5)
SYMBOL res 2624 1008 R0
SYMATTR InstName R4
SYMATTR Value 1
SYMBOL cap 2528 656 R0
SYMATTR InstName C2
SYMATTR Value 3n
SYMBOL cap 2528 848 R0
SYMATTR InstName C3
SYMATTR Value 3n
SYMBOL cap 2528 1040 R0
SYMATTR InstName C4
SYMATTR Value 3n
SYMBOL res 2112 1744 R0
SYMATTR InstName R5
SYMATTR Value 10Meg
SYMBOL res 976 672 R0
SYMATTR InstName R7
SYMATTR Value 30Meg
SYMBOL bi 1744 1872 M180
WINDOW 0 24 80 Left 2
WINDOW 3 24 0 Left 2
SYMATTR InstName B8
SYMATTR Value I=V(didt_a)
SYMBOL cap 1632 1808 R0
WINDOW 39 -15 -19 Left 2
SYMATTR SpiceLine IC={i0_a}
SYMATTR InstName C7
SYMATTR Value 1
SYMBOL res 1536 1776 R0
SYMATTR InstName R10
SYMATTR Value 1Meg
SYMBOL bv 1088 1552 R0
SYMATTR InstName B9
SYMATTR Value V=(-V(w)*V(ke_shaped_a)+V(phase_a,common)-I(V_a)*{Ra})/{La}
SYMBOL bv 368 1552 R0
SYMATTR InstName B11
SYMATTR Value V={sin_trap}*V(ke_sin_a)+(1-{sin_trap})*V(ke_trap_a)
SYMBOL bv 32 1680 R0
SYMATTR InstName B12
SYMATTR Value V=V(npp_angle)+0.523598775598299
SYMBOL bv 2192 1104 R0
SYMATTR InstName B5
SYMATTR Value V={Npp}*V(Angle)
SYMBOL bv 144 1632 R0
SYMATTR InstName B10
SYMATTR Value V={Ke}*sin(V(e_angle_a))
SYMBOL bv 256 1600 R0
SYMATTR InstName B13
SYMATTR Value V={Ke}*(uramp(V(e_angle_mod_a)/0.523598775598299)-uramp((V(e_angle_mod_a)-0.523598775598299)/0.523598775598299)-uramp((V(e_angle_mod_a)-2.61799387799149)/0.523598775598299)+uramp((V(e_angle_mod_a)-3.66519142918809)/0.523598775598299)+uramp((V(e_angle_mod_a)-5.75958653158129)/523.599m))
SYMBOL bv 1072 1792 R0
SYMATTR InstName B6
SYMATTR Value V=(V(e_rot_a)-floor(V(e_rot_a)))*2*pi
SYMBOL bv 720 1792 R0
SYMATTR InstName B14
SYMATTR Value V=V(e_angle_a)/2/pi
SYMBOL g2 2544 1856 M180
SYMATTR InstName G_a
SYMATTR Value 1
SYMBOL bv 2688 1760 R0
SYMATTR InstName B7
SYMATTR Value V=V(ke_shaped_a)*V(i_phs_a)
SYMBOL bv 1168 672 R0
SYMATTR InstName B15
SYMATTR Value V=V(t_a)+V(t_b)+V(t_c)
SYMBOL bv 448 624 R0
SYMATTR InstName B16
SYMATTR Value V=V(t_in)+V(t_out)
SYMBOL res 2256 592 R0
SYMATTR InstName R6
SYMATTR Value 1G
SYMBOL res 704 624 R0
SYMATTR InstName R8
SYMATTR Value 1G
SYMBOL bv 448 768 R0
SYMATTR InstName B17
SYMATTR Value V=abs(V(tx))*{fb}/({fb}+{fc}+abs(V(w)))
SYMBOL bv 448 912 R0
SYMATTR InstName B18
SYMATTR Value V={tfk}*(1-1/(1+{tfk}*abs(v(w))))
SYMBOL bv 448 1056 R0
SYMATTR InstName B19
SYMATTR Value V=V(tf0)+V(tf1)
SYMBOL bv 448 1200 R0
SYMATTR InstName B20
SYMATTR Value V=-(2*u(V(w))/2)*((0.5+tanh(10meg*(V(tf2)-{tfs}))/2)*{tfs}+(0.5+tanh(10meg*(-V(tf2)+{tfs}))/2)*V(tf2))
SYMBOL bv 448 1344 R0
SYMATTR InstName B21
SYMATTR Value V=V(tf)+V(tx)-(abs(V(damp))+{dm})*V(w)
SYMBOL bi 1808 928 M180
WINDOW 0 24 80 Left 2
WINDOW 3 24 0 Left 2
SYMATTR InstName B22
SYMATTR Value I=V(accel)
SYMBOL cap 1696 864 R0
WINDOW 39 -15 -19 Left 2
SYMATTR SpiceLine IC={w0}
SYMATTR InstName C5
SYMATTR Value 1
SYMBOL res 1600 832 R0
SYMATTR InstName R9
SYMATTR Value 1Meg
SYMBOL bi 2192 928 M180
WINDOW 0 24 80 Left 2
WINDOW 3 24 0 Left 2
SYMATTR InstName B23
SYMATTR Value I=V(w)
SYMBOL cap 2080 864 R0
WINDOW 39 -15 -19 Left 2
SYMATTR SpiceLine IC={angle0}
SYMATTR InstName C6
SYMATTR Value 1
SYMBOL res 1984 832 R0
SYMATTR InstName R11
SYMATTR Value 1Meg
SYMBOL res 2112 2160 R0
SYMATTR InstName R12
SYMATTR Value 10Meg
SYMBOL bi 1744 2288 M180
WINDOW 0 24 80 Left 2
WINDOW 3 24 0 Left 2
SYMATTR InstName B24
SYMATTR Value I=V(didt_b)
SYMBOL cap 1632 2224 R0
WINDOW 39 -15 -19 Left 2
SYMATTR SpiceLine IC={i0_b}
SYMATTR InstName C8
SYMATTR Value 1
SYMBOL res 1536 2192 R0
SYMATTR InstName R13
SYMATTR Value 1Meg
SYMBOL bv 1088 1968 R0
SYMATTR InstName B25
SYMATTR Value V=(-V(w)*V(ke_shaped_b)+V(phase_b,common)-I(V_b)*{Rb})/{Lb}
SYMBOL bv 368 1968 R0
SYMATTR InstName B26
SYMATTR Value V={sin_trap}*V(ke_sin_b)+(1-{sin_trap})*V(ke_trap_b)
SYMBOL bv 32 2096 R0
SYMATTR InstName B27
SYMATTR Value V=V(npp_angle)-1.5707963267949
SYMBOL bv 144 2048 R0
SYMATTR InstName B28
SYMATTR Value V={Ke}*sin(V(e_angle_b))
SYMBOL bv 256 2016 R0
SYMATTR InstName B29
SYMATTR Value V={Ke}*(uramp(V(e_angle_mod_b)/0.523598775598299)-uramp((V(e_angle_mod_b)-0.523598775598299)/0.523598775598299)-uramp((V(e_angle_mod_b)-2.61799387799149)/0.523598775598299)+uramp((V(e_angle_mod_b)-3.66519142918809)/0.523598775598299)+uramp((V(e_angle_mod_b)-5.75958653158129)/523.599m))
SYMBOL bv 1072 2208 R0
SYMATTR InstName B30
SYMATTR Value V=(V(e_rot_b)-floor(V(e_rot_b)))*2*pi
SYMBOL bv 720 2208 R0
SYMATTR InstName B31
SYMATTR Value V=V(e_angle_b)/2/pi
SYMBOL g2 2544 2272 M180
SYMATTR InstName G_b
SYMATTR Value 1
SYMBOL bv 2688 2176 R0
SYMATTR InstName B32
SYMATTR Value V=V(ke_shaped_b)*V(i_phs_b)
SYMBOL res 2112 2576 R0
SYMATTR InstName R14
SYMATTR Value 10Meg
SYMBOL bi 1744 2704 M180
WINDOW 0 24 80 Left 2
WINDOW 3 24 0 Left 2
SYMATTR InstName B33
SYMATTR Value I=V(didt_c)
SYMBOL cap 1632 2640 R0
WINDOW 39 -15 -19 Left 2
SYMATTR SpiceLine IC={i0_c}
SYMATTR InstName C9
SYMATTR Value 1
SYMBOL res 1536 2608 R0
SYMATTR InstName R15
SYMATTR Value 1Meg
SYMBOL bv 1088 2384 R0
SYMATTR InstName B34
SYMATTR Value V=(-V(w)*V(ke_shaped_c)+V(phase_c,common)-I(V_c)*{Rc})/{Lc}
SYMBOL bv 368 2384 R0
SYMATTR InstName B35
SYMATTR Value V={sin_trap}*V(ke_sin_c)+(1-{sin_trap})*V(ke_trap_c)
SYMBOL bv 32 2512 R0
SYMATTR InstName B36
SYMATTR Value V=V(npp_angle)+2.61799387799149
SYMBOL bv 144 2464 R0
SYMATTR InstName B37
SYMATTR Value V={Ke}*sin(V(e_angle_c))
SYMBOL bv 256 2432 R0
SYMATTR InstName B38
SYMATTR Value V={Ke}*(uramp(V(e_angle_mod_c)/0.523598775598299)-uramp((V(e_angle_mod_c)-0.523598775598299)/0.523598775598299)-uramp((V(e_angle_mod_c)-2.61799387799149)/0.523598775598299)+uramp((V(e_angle_mod_c)-3.66519142918809)/0.523598775598299)+uramp((V(e_angle_mod_c)-5.75958653158129)/523.599m))
SYMBOL bv 1072 2624 R0
SYMATTR InstName B39
SYMATTR Value V=(V(e_rot_c)-floor(V(e_rot_c)))*2*pi
SYMBOL bv 720 2624 R0
SYMATTR InstName B40
SYMATTR Value V=V(e_angle_c)/2/pi
SYMBOL g2 2544 2688 M180
SYMATTR InstName G_c
SYMATTR Value 1
SYMBOL bv 2688 2592 R0
SYMATTR InstName B41
SYMATTR Value V=V(ke_shaped_c)*V(i_phs_c)
SYMBOL voltage 2368 1888 R90
WINDOW 0 -32 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName V_a
SYMATTR Value 0V
SYMBOL voltage 2368 2304 R90
WINDOW 0 -32 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName V_b
SYMATTR Value 0V
SYMBOL voltage 2368 2720 R90
WINDOW 0 -32 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName V_c
SYMATTR Value 0V
TEXT 3152 1224 Left 2 ;gHall of 200k => ~10ns rise/fall time
TEXT 2832 688 Left 2 ;I={VDD_Hall}*(0.5*tanh({gHall}*sin({Npp}*(V(Angle)+0+{Ph})))+0.5)
TEXT 2912 1192 Left 2 ;Hall_Hyst = Difference between rising and falling trip points in radians
TEXT 1408 992 Left 2 ;NGspice has no "idt" function, \nbut instead a "int" model, \nwhich LTspice does not have.
