.subckt stator_drive_netlist input_v_p input_v_m sw_node_hs hs_drive N023
XX1 input_v_p input_v_m sw_node_hs hs_drive N023
.ends stator_drive_netlist



******************************************************************************************************************
* STEPS TO GET FROM LTSPICE NETLIST TO THIS NGSPICE NETLIST:
* Delete everything that's not a subcircuit (including end of file top-level statements such as .tran, .end);
* This file is only a collection of subcircuits, not a complete SPICE netlist.
* Add parameters to each subckt line (just copy from any instantiation of said subcircuit; do not include "params:")
* Change unicode 'mu' to 'u'
* Replace any dash in any subcircuit name with an underscore 
* Add top subcircuit ngspice_top using instantiation line for XX1 in original top-level netlist (see text before this note)
*	It is important to include the XX1 instantiation as above otherwise the models below do not get connected
******************************************************************************************************************

.subckt stator_drive_netlist input_v_p input_v_m sw_node_hs hs_drive N023

*plus supply output
*N004 is the top of ALE caps node
*R1 input_v_p N001 26.4m
*L1 N001 N002 800n
*R2 N002 N003 6m
*L2 N003 N004 20n

*minus supply output
*N017 is the top of ALE caps node
*R9 input_v_m N014 26.4m
*L9 N014 N015 800n
*R10 N015 N016 6m
*L10 N016 N017 20n

*Plus ALE cap
*R3 N004 N005 0.8m
*L3 N005 N006 50n
*R4 N006 N007 0.1
*L4 N007 N008 200n
*R5 N008 N009 0.0126
*C1 N009 0 10000u

*Minus ALE cap
*R11 N017 N018 0.8m
*L11 N018 N019 50n
*R12 N019 N020 0.1
*L12 N020 N021 200n
*R13 N021 N022 0.0126
*C3 N022 0 10000u

*Plus fuses output is N011
*L6 N004 N010 60n
*R6 N010 N011 1.1m

*minus fuses output is N019
*L14 N017 N018 60n
*R14 N018 N019 1.1m

* Plus film caps
*R7 N011 N012 0.2
*R8 N012 N013 0.0016
*C2 N013 0 100u

* Minus film caps
*R15 N019 N020 0.2
*R16 N020 N021 0.0016
*C4 N021 0 100u

* plus switch, N023 is the switch drive
*R17 N011 N022 0.0036
*S1 N022 sw_node N023 0 myswitch
*D1 sw_node N022 1N5819
* drive circuit with deadband
*R18 hs_drive N023 10
*R19 hs_drive 0 10
*C5 N023 0 10n
*D2 N023 hs_drive 1N5819

* minus switch, N025 is the switch drive
*R20 sw_node N024 0.0036
*S2 N024 N019 N025 0 myswitch
*D3 N019 N024 1N5819
* drive circuit with deadband
*R21 ls_drive N025 10
*R22 ls_drive 0 10
*C6 N025 0 10n
*D4 N025 ls_drive 1N5819


* this setup uses only the input voltage sources to make the simulation more simple

* Minus film caps
*R15 input_v_m N020 0.2
*R16 N020 N021 0.0016
*C4 N021 0 100u
* Plus film caps
*R7 input_v_p N012 0.2
*R8 input_v_p N013 0.0016
*C2 N013 0 100u

* plus switch, N023 is the switch drive
*R17 N011 N022 0.0036
*R17 input_v_p N022 0.0036
V1 N043 0 100
R17 N043 sw_node_hs 0.0036

*R17 hs_drive 0 1
*S1 sw_node_hs 0 N040 0 myswitch

* M1 
M1 N001 sw_node_hs N023 0 irf150

*D1 sw_node_hs input_v_p 1N5819
* drive circuit with deadband
R18 hs_drive N023 10
R19 hs_drive 0 10
C5 N023 0 10n
*D2 N023 hs_drive 1N5819

* minus switch, N025 is the switch drive
*R20 sw_node_ls N024 0.0036
*S2 N024 N019 N025 0 myswitch
*D3 N019 N024 1N5819
*S2 N024 input_v_m N025 0 myswitch
*D3 input_v_m sw_node_ls 1N5819
* drive circuit with deadband
*R21 ls_drive N025 10
*R22 ls_drive 0 10
*C6 N025 0 10n
*D4 N025 ls_drive 1N5819


*output load
R23 0 sw_node_hs 70
*L23 N026 0 70u


* driver comparing sin to tri references
* high side comparator
*V1 N100 0 10
*R24 N100 N101 10
*S3 N101 0 sin_ref tri_ref myswitch
* inverted for low side
*V2 N102 0 10
*R25 N102 N103 10
*S4 N103 0 tri_ref sin_ref myswitch

*B1 hs_drive 0 V=V(N101)
*B2 ls_drive 0 V=V(N103)


* had to hard code the duty cycle because cannot yet pass time values to/from python code
*V2 gate_drive 0 PULSE(0 10 0 1n 1n 1.25u 2.5u 200)

*.model 1N5819 D(Is=31.7u Rs=.051 N=1.373 Cjo=110p M=.35 Eg=.69 Xti=2 Iave=1 Vpk=400 type=Schottky)
.model myswitch SW(Ron=0.002 Roff=1Meg Vt=3.0)

.ends stator_drive_netlist


* -*- spice -*-
* http://www.irf.com/product-info/models/spice/irf150.spi
*
.SUBCKT irf150 1 2 3
**************************************
*      Model Generated by MODPEX     *
*Copyright(c) Symmetry Design Systems*
*         All Rights Reserved        *
*    UNPUBLISHED LICENSED SOFTWARE   *
*   Contains Proprietary Information *
*      Which is The Property of      *
*     SYMMETRY OR ITS LICENSORS      *
*Commercial Use or Resale Restricted *
*   by Symmetry License Agreement    *
**************************************
* Model generated on Dec 17, 96
* MODEL FORMAT: SPICE3
* Symmetry POWER MOS Model (Version 1.0)
* External Node Designations
* Node 1 -> Drain
* Node 2 -> Gate
* Node 3 -> Source
M1 9 7 8 8 MM L=100u W=100u
* Default values used in MM:
* The voltage-dependent capacitances are
* not included. Other default values are:
*   RS=0 RD=0 LD=0 CBD=0 CBS=0 CGBO=0
.MODEL MM NMOS LEVEL=1 IS=1e-32
+VTO=4.07861 LAMBDA=0.000761669 KP=19.0218
+CGSO=3.57784e-05 CGDO=4.96221e-07
RS 8 3 0.0216597
D1 3 1 MD
.MODEL MD D IS=2.01865e-09 RS=0.11592 N=1.5 BV=100
+IBV=0.001 EG=1 XTI=1 TT=1e-07
+CJO=3.28974e-09 VJ=4.39387 M=0.659734 FC=0.1
RDS 3 1 3.2e+06
RD 9 1 0.00224103
RG 2 7 12.1
D2 4 5 MD1
* Default values used in MD1:
*   RS=0 EG=1.11 XTI=3.0 TT=0
*   BV=infinite IBV=1mA
.MODEL MD1 D IS=1e-32 N=50
+CJO=3.78329e-09 VJ=0.607074 M=0.893797 FC=1e-08
D3 0 5 MD2
* Default values used in MD2:
*   EG=1.11 XTI=3.0 TT=0 CJO=0
*   BV=infinite IBV=1mA
.MODEL MD2 D IS=1e-10 N=0.402271 RS=3.00001e-06
RL 5 10 1
FI2 7 9 VFI2 -1
VFI2 4 0 0
EV16 10 0 9 7 1
CAP 11 10 3.78329e-09
FI1 7 9 VFI1 -1
VFI1 11 6 0
RCAP 6 10 1
D4 0 6 MD3
* Default values used in MD3:
*   EG=1.11 XTI=3.0 TT=0 CJO=0
*   RS=0 BV=infinite IBV=1mA
.MODEL MD3 D IS=1e-10 N=0.402271
.ENDS irf150